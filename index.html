<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stock Broker Client Dashboard</title>

  <!-- Chart.js for live graphs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.5.0/chart.umd.min.js"></script>
  <!-- jsPDF for PDF download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #4fa3ff, #0b3a82 60%, #021734);
      color: #f5f7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #app {
      width: 100%;
      max-width: 1150px;
    }

    .card {
      background: rgba(0, 22, 56, 0.92);
      border-radius: 18px;
      padding: 26px 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(14px);
    }

    .title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 13px;
      opacity: 0.8;
      margin-bottom: 18px;
    }

    .input-group {
      margin-bottom: 12px;
    }

    label {
      font-size: 13px;
      opacity: 0.85;
      display: block;
      margin-bottom: 5px;
    }

    input[type="email"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(4, 29, 82, 0.9);
      color: #f5f7ff;
      outline: none;
      font-size: 14px;
    }

    input[type="email"]::placeholder {
      color: rgba(244, 248, 255, 0.6);
    }

    .error-text {
      font-size: 12px;
      color: #ff8b8b;
      min-height: 16px;
      margin-top: 4px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 9px 18px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.1s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #45e2ff, #2d9bff);
      color: #001533;
      box-shadow: 0 10px 18px rgba(17, 186, 255, 0.4);
      width: 100%;
      margin-top: 10px;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(17, 186, 255, 0.6);
    }

    .btn-secondary {
      background: rgba(9, 42, 92, 0.9);
      color: #f5f7ff;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .btn-secondary:hover {
      background: rgba(18, 62, 129, 0.95);
    }

    #login-screen {
      max-width: 420px;
      margin: 0 auto;
    }

    #dashboard {
      display: none;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(8, 165, 255, 0.12);
      border: 1px solid rgba(8, 165, 255, 0.35);
      color: #9ed9ff;
      margin-top: 4px;
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: #47ff8e;
      box-shadow: 0 0 8px rgba(71, 255, 142, 0.8);
    }

    .user-email {
      font-size: 13px;
      opacity: 0.8;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.5fr);
      gap: 18px;
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(33, 114, 255, 0.2), rgba(5, 18, 54, 0.96));
      border-radius: 16px;
      padding: 14px 16px 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .panel-title {
      font-size: 15px;
      font-weight: 600;
    }

    .panel-subtitle {
      font-size: 11px;
      opacity: 0.75;
      margin-top: 2px;
    }

    .stock-list {
      margin-top: 10px;
    }

    .stock-row {
      display: grid;
      grid-template-columns: 0.7fr 1fr 0.9fr;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(3, 23, 62, 0.86);
      border: 1px solid rgba(255, 255, 255, 0.04);
      margin-bottom: 6px;
    }

    .stock-row:hover {
      border-color: rgba(116, 192, 255, 0.5);
    }

    .stock-ticker {
      font-weight: 600;
      font-size: 14px;
    }

    .stock-price {
      font-family: "Consolas", "Courier New", monospace;
      font-size: 13px;
      transition: color 0.2s ease;
    }

    .stock-status {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 3px;
    }

    .charts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .switch-group {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      opacity: 0.8;
    }

    #chartsGrid {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
      gap: 12px;
    }

    .chart-card {
      background: rgba(2, 16, 46, 0.95);
      border-radius: 12px;
      padding: 8px 10px 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .chart-card-title {
      font-size: 12px;
      opacity: 0.85;
      margin-bottom: 4px;
    }

    .chart-wrapper {
      position: relative;
      height: 170px;
    }

    .activity-grid {
      margin-top: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 0.9fr);
      gap: 14px;
    }

    .activity-list {
      max-height: 160px;
      overflow-y: auto;
      padding-right: 6px;
      margin-top: 6px;
    }

    .activity-item {
      font-size: 12px;
      padding: 6px 7px;
      border-radius: 9px;
      background: rgba(2, 17, 44, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 5px;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .activity-left span:first-child {
      font-weight: 600;
      margin-right: 4px;
    }

    .activity-time {
      font-size: 11px;
      opacity: 0.7;
      white-space: nowrap;
    }

    #downloadPdfBtn {
      width: 100%;
      margin-top: 8px;
    }

    @media (max-width: 900px) {
      .dashboard-grid,
      .activity-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- LOGIN -->
    <div id="login-screen" class="card">
      <div class="title">Login to Stock Dashboard</div>
      <div class="subtitle">Use your email to subscribe and track live stock prices.</div>

      <div class="input-group">
        <label for="emailInput">Email Address</label>
        <input id="emailInput" type="email" placeholder="you@example.com" />
        <div id="loginError" class="error-text"></div>
      </div>

      <button id="loginBtn" class="btn btn-primary">Continue</button>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="card">
      <div class="dashboard-header">
        <div>
          <div class="title">Stock Broker Client Dashboard</div>
          <div id="userEmailDisplay" class="user-email"></div>
          <div class="badge">
            <span class="dot"></span>
            Live prices update every second
          </div>
        </div>
        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
      </div>

      <div class="dashboard-grid">
        <!-- LEFT: STOCKS -->
        <div class="panel">
          <div class="panel-title">Supported Stocks</div>
          <div class="panel-subtitle">
            Subscribe to start streaming prices and graphs.
          </div>
          <div id="stockList" class="stock-list"></div>
        </div>

        <!-- RIGHT: CHARTS -->
        <div class="panel">
          <div class="charts-header">
            <div>
              <div class="panel-title">Live Price Graphs</div>
              <div class="panel-subtitle">
                Each subscribed stock gets its own live chart.
              </div>
            </div>
            <div class="switch-group">
              <label for="chartStyleSelect">Chart style:</label>
              <select id="chartStyleSelect" style="font-size:11px;padding:2px 4px;border-radius:6px;border:none;">
                <option value="line">Line</option>
                <option value="area">Area (filled)</option>
              </select>
            </div>
          </div>

          <div id="chartsGrid"></div>
        </div>
      </div>

      <!-- ACTIVITY + PDF -->
      <div class="activity-grid">
        <div class="panel">
          <div class="panel-title">Subscription Activity</div>
          <div class="panel-subtitle">
            All subscribe / unsubscribe actions for this user.
          </div>
          <div id="activityList" class="activity-list"></div>
        </div>

        <div class="panel">
          <div class="panel-title">Download Report</div>
          <div class="panel-subtitle">
            Generate a PDF of your subscription history.
          </div>
          <button id="downloadPdfBtn" class="btn btn-primary">
            Download PDF Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------- CONFIG & STATE ----------------
    const SUPPORTED_STOCKS = ["GOOG", "TSLA", "AMZN", "META", "NVDA"];
    const USERS_STORAGE_KEY = "stockDashboardUsers";
    const CURRENT_USER_KEY = "stockDashboardCurrentUser";
    const MAX_POINTS = 30;

    // state
    let prices = {};
    let prevPrices = {};
    let currentUserEmail = null;
    let currentUserData = null;
    let charts = {}; // ticker -> Chart instance
    let chartStyle = "line"; // "line" or "area"

    // ---------------- HELPERS: STORAGE ----------------
    function getAllUsers() {
      try {
        return JSON.parse(localStorage.getItem(USERS_STORAGE_KEY)) || {};
      } catch {
        return {};
      }
    }

    function saveAllUsers(users) {
      localStorage.setItem(USERS_STORAGE_KEY, JSON.stringify(users));
    }

    function loadUser(email) {
      const users = getAllUsers();
      if (!users[email]) {
        users[email] = { subscriptions: [], history: [] };
        saveAllUsers(users);
      }
      return users[email];
    }

    function saveCurrentUser() {
      if (!currentUserEmail || !currentUserData) return;
      const users = getAllUsers();
      users[currentUserEmail] = currentUserData;
      saveAllUsers(users);
    }

    // ---------------- PRICES ----------------
    function initPrices() {
      SUPPORTED_STOCKS.forEach((ticker) => {
        const base = {
          GOOG: 1400,
          TSLA: 220,
          AMZN: 115,
          META: 270,
          NVDA: 480,
        }[ticker] || 100;

        const startPrice = +(base + (Math.random() - 0.5) * 10).toFixed(2);
        prices[ticker] = startPrice;
        prevPrices[ticker] = startPrice;
      });
    }

    function updatePrices() {
      SUPPORTED_STOCKS.forEach((ticker) => {
        const old = prices[ticker];
        prevPrices[ticker] = old;

        const changePct = (Math.random() - 0.5) * 0.6; // -0.3% to +0.3%
        let next = old * (1 + changePct / 100);
        if (next < 1) next = 1;
        prices[ticker] = +next.toFixed(2);

        const priceEl = document.getElementById(`price-${ticker}`);
        if (priceEl) {
          priceEl.textContent = `$${prices[ticker].toFixed(2)}`;

          if (prices[ticker] > prevPrices[ticker]) {
            priceEl.style.color = "#4cff7a"; // green
          } else if (prices[ticker] < prevPrices[ticker]) {
            priceEl.style.color = "#ff5e5e"; // red
          } else {
            priceEl.style.color = "#ffffff";
          }
        }
      });
    }

    // ---------------- UI: STOCK LIST ----------------
    function renderStockList() {
      const container = document.getElementById("stockList");
      container.innerHTML = "";

      SUPPORTED_STOCKS.forEach((ticker) => {
        const subscribed = currentUserData.subscriptions.includes(ticker);

        const row = document.createElement("div");
        row.className = "stock-row";

        const left = document.createElement("div");
        left.className = "stock-ticker";
        left.textContent = ticker;

        const middle = document.createElement("div");
        const priceEl = document.createElement("div");
        priceEl.id = `price-${ticker}`;
        priceEl.className = "stock-price";
        priceEl.textContent = `$${(prices[ticker] || 0).toFixed(2)}`;

        const statusEl = document.createElement("div");
        statusEl.className = "stock-status";
        statusEl.textContent = subscribed ? "Subscribed (live)" : "Not subscribed";

        middle.appendChild(priceEl);
        middle.appendChild(statusEl);

        const right = document.createElement("div");
        right.style.textAlign = "right";

        const btn = document.createElement("button");
        btn.className = "btn btn-secondary";
        btn.style.fontSize = "11px";
        btn.style.padding = "6px 10px";
        btn.textContent = subscribed ? "Unsubscribe" : "Subscribe";
        btn.dataset.ticker = ticker;
        btn.addEventListener("click", onToggleSubscription);

        right.appendChild(btn);

        row.appendChild(left);
        row.appendChild(middle);
        row.appendChild(right);

        container.appendChild(row);
      });
    }

    // ---------------- ACTIVITY ----------------
    function addActivity(action, ticker) {
      const entry = {
        action,
        ticker,
        time: new Date().toLocaleString(),
      };
      currentUserData.history.push(entry);
      saveCurrentUser();
      renderActivity();
    }

    function renderActivity() {
      const list = document.getElementById("activityList");
      list.innerHTML = "";

      if (!currentUserData.history.length) {
        const empty = document.createElement("div");
        empty.className = "panel-subtitle";
        empty.style.marginTop = "8px";
        empty.textContent = "No activity yet. Subscribe to a stock to get started.";
        list.appendChild(empty);
        return;
      }

      currentUserData.history
        .slice()
        .reverse()
        .forEach((entry) => {
          const item = document.createElement("div");
          item.className = "activity-item";

          const left = document.createElement("div");
          left.className = "activity-left";
          left.innerHTML = `<span>${entry.ticker}</span><span>â€¢ ${entry.action}</span>`;

          const right = document.createElement("div");
          right.className = "activity-time";
          right.textContent = entry.time;

          item.appendChild(left);
          item.appendChild(right);
          list.appendChild(item);
        });
    }

    // ---------------- CHARTS ----------------
    function createChartCard(ticker) {
      const grid = document.getElementById("chartsGrid");

      const card = document.createElement("div");
      card.className = "chart-card";
      card.id = `chart-card-${ticker}`;

      const title = document.createElement("div");
      title.className = "chart-card-title";
      title.textContent = `${ticker} - Live Price`;

      const wrapper = document.createElement("div");
      wrapper.className = "chart-wrapper";

      const canvas = document.createElement("canvas");
      canvas.id = `chart-${ticker}`;

      wrapper.appendChild(canvas);
      card.appendChild(title);
      card.appendChild(wrapper);
      grid.appendChild(card);

      const ctx = canvas.getContext("2d");

      const filled = chartStyle === "area";
      const color = {
        GOOG: "#ff6384",
        TSLA: "#36a2eb",
        AMZN: "#ffcd56",
        META: "#4bc0c0",
        NVDA: "#9966ff",
      }[ticker] || "#4bc0c0";

      const chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: ticker,
              data: [],
              borderColor: color,
              backgroundColor: filled ? color + "33" : "rgba(0,0,0,0)",
              fill: filled,
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 1.5,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 300,
          },
          plugins: {
            legend: {
              labels: {
                color: "#f5f7ff",
                font: { size: 11 },
              },
            },
          },
          scales: {
            x: {
              ticks: {
                color: "rgba(245,247,255,0.8)",
                maxRotation: 0,
                autoSkip: true,
              },
              grid: {
                color: "rgba(255,255,255,0.06)",
              },
            },
            y: {
              ticks: {
                color: "rgba(245,247,255,0.8)",
              },
              grid: {
                color: "rgba(255,255,255,0.06)",
              },
            },
          },
        },
      });

      charts[ticker] = chart;
    }

    function destroyChartCard(ticker) {
      if (charts[ticker]) {
        charts[ticker].destroy();
        delete charts[ticker];
      }
      const card = document.getElementById(`chart-card-${ticker}`);
      if (card && card.parentNode) {
        card.parentNode.removeChild(card);
      }
    }

    function rebuildChartsForSubscriptions() {
      // destroy all
      Object.keys(charts).forEach((t) => destroyChartCard(t));

      if (!currentUserData) return;
      currentUserData.subscriptions.forEach((ticker) => {
        createChartCard(ticker);
      });
    }

    function pushChartData() {
      if (!currentUserData) return;

      const nowLabel = new Date().toLocaleTimeString();

      currentUserData.subscriptions.forEach((ticker) => {
        const chart = charts[ticker];
        if (!chart) return;

        chart.data.labels.push(nowLabel);
        if (chart.data.labels.length > MAX_POINTS) {
          chart.data.labels.shift();
        }

        const value = prices[ticker] || 0;
        chart.data.datasets[0].data.push(value);
        if (chart.data.datasets[0].data.length > MAX_POINTS) {
          chart.data.datasets[0].data.shift();
        }

        chart.update("none");
      });
    }

    // ---------------- SUBSCRIBE / UNSUBSCRIBE ----------------
    function onToggleSubscription(e) {
      const ticker = e.target.dataset.ticker;
      if (!ticker) return;

      const subs = currentUserData.subscriptions;
      const idx = subs.indexOf(ticker);

      if (idx === -1) {
        subs.push(ticker);
        addActivity("Subscribed", ticker);
        createChartCard(ticker);
      } else {
        subs.splice(idx, 1);
        addActivity("Unsubscribed", ticker);
        destroyChartCard(ticker);
      }

      saveCurrentUser();
      renderStockList();
    }

    // ---------------- LOGIN / LOGOUT ----------------
    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function showDashboard(email) {
      currentUserEmail = email;
      currentUserData = loadUser(email);

      document.getElementById("userEmailDisplay").textContent =
        "Logged in as: " + email;

      document.getElementById("login-screen").style.display = "none";
      document.getElementById("dashboard").style.display = "block";

      renderStockList();
      renderActivity();
      rebuildChartsForSubscriptions();
    }

    function logout() {
      currentUserEmail = null;
      currentUserData = null;
      localStorage.removeItem(CURRENT_USER_KEY);
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("login-screen").style.display = "block";
      document.getElementById("emailInput").value = "";
      document.getElementById("loginError").textContent = "";
    }

    // ---------------- PDF REPORT ----------------
    function downloadPdfReport() {
      if (!currentUserEmail || !currentUserData) return;

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Stock Subscription Report", 14, 18);

      doc.setFontSize(11);
      doc.text("User: " + currentUserEmail, 14, 28);
      doc.text("Generated at: " + new Date().toLocaleString(), 14, 34);

      let y = 46;
      doc.setFontSize(12);
      doc.text("Currently Subscribed Stocks:", 14, y);
      y += 6;
      doc.setFontSize(11);

      if (!currentUserData.subscriptions.length) {
        doc.text("- None", 18, y);
        y += 8;
      } else {
        currentUserData.subscriptions.forEach((ticker) => {
          doc.text("- " + ticker, 18, y);
          y += 6;
        });
        y += 2;
      }

      y += 6;
      doc.setFontSize(12);
      doc.text("Subscription Activity:", 14, y);
      y += 6;
      doc.setFontSize(10);

      if (!currentUserData.history.length) {
        doc.text("No subscription / unsubscription activity yet.", 18, y);
      } else {
        currentUserData.history.forEach((entry) => {
          const line = `${entry.time}  |  ${entry.action}  ${entry.ticker}`;
          if (y > 280) {
            doc.addPage();
            y = 20;
          }
          doc.text(line, 18, y);
          y += 6;
        });
      }

      const filename =
        "stock_report_" + currentUserEmail.replace(/[^a-z0-9]/gi, "_") + ".pdf";
      doc.save(filename);
    }

    // ---------------- INIT ----------------
    document.addEventListener("DOMContentLoaded", () => {
      initPrices();

      const loginBtn = document.getElementById("loginBtn");
      const emailInput = document.getElementById("emailInput");
      const loginError = document.getElementById("loginError");
      const logoutBtn = document.getElementById("logoutBtn");
      const downloadPdfBtn = document.getElementById("downloadPdfBtn");
      const chartStyleSelect = document.getElementById("chartStyleSelect");

      // Auto-login if saved
      const savedEmail = localStorage.getItem(CURRENT_USER_KEY);
      if (savedEmail) {
        showDashboard(savedEmail);
      }

      loginBtn.addEventListener("click", () => {
        const email = emailInput.value.trim();
        if (!email) {
          loginError.textContent = "Please enter your email.";
          return;
        }
        if (!validateEmail(email)) {
          loginError.textContent = "Please enter a valid email address.";
          return;
        }
        loginError.textContent = "";
        localStorage.setItem(CURRENT_USER_KEY, email);
        showDashboard(email);
      });

      emailInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          loginBtn.click();
        }
      });

      logoutBtn.addEventListener("click", logout);
      downloadPdfBtn.addEventListener("click", downloadPdfReport);

      chartStyleSelect.addEventListener("change", (e) => {
        chartStyle = e.target.value === "area" ? "area" : "line";
        rebuildChartsForSubscriptions();
      });

      // Main live loop
      setInterval(() => {
        updatePrices();
        if (currentUserData && currentUserData.subscriptions.length) {
          pushChartData();
        }
      }, 1000);
    });
  </script>
</body>
</html>